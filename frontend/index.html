<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App - Frontend</title>
    <!-- Tailwind CSS CDN for quick styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #334155; /* Dark slate text */
        }
        /* Hide sections by default, show based on JS */
        .page-section {
            display: none;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 0.75rem; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn {
            @apply px-4 py-2 rounded-md font-medium transition-colors duration-200;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 hover:bg-gray-300;
        }
        .btn-danger {
            @apply bg-red-500 text-white hover:bg-red-600;
        }
        .btn-success {
            @apply bg-green-500 text-white hover:bg-green-600;
        }
        input[type="text"],
        input[type="email"],
        input[type="password"] {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .message-box {
            @apply p-3 mt-4 rounded-md text-sm font-medium;
        }
        .message-success {
            @apply bg-green-100 text-green-700 border border-green-200;
        }
        .message-error {
            @apply bg-red-100 text-red-700 border border-red-200;
        }
        .message-info {
            @apply bg-blue-100 text-blue-700 border border-blue-200;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-blue-700 text-white p-4 shadow-md">
        <div class="container flex justify-between items-center mx-auto">
            <h1 class="text-2xl font-bold">My Todo App</h1>
            <h1 class="text-2xl font-bold">My Todo App</h1>
            <nav>
                <button id="navLogin" class="btn btn-secondary mr-2">Login</button>
                <button id="navRegister" class="btn btn-secondary mr-2">Register</button>
                <button id="navTodos" class="btn btn-secondary mr-2" style="display: none;">Todos</button>
                <button id="navLogout" class="btn btn-danger" style="display: none;">Logout</button>
            </nav>
        </div>
    </header>

    <main class="flex-grow p-4">
        <div class="container">
            <div id="messageBox" class="message-box" style="display: none;"></div>

            <!-- Login Section -->
            <section id="loginSection" class="page-section active">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Login</h2>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label for="loginEmail" class="block text-sm font-medium text-gray-700">Email:</label>
                        <input type="email" id="loginEmail" name="email" required class="mt-1">
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700">Password:</label>
                        <input type="password" id="loginPassword" name="password" required class="mt-1">
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Login</button>
                </form>
            </section>

            <!-- Register Section -->
            <section id="registerSection" class="page-section">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Register</h2>
                <form id="registerForm" class="space-y-4">
                    <div>
                        <label for="registerEmail" class="block text-sm font-medium text-gray-700">Email:</label>
                        <input type="email" id="registerEmail" name="email" required class="mt-1">
                    </div>
                    <div>
                        <label for="registerPassword" class="block text-sm font-medium text-gray-700">Password:</label>
                        <input type="password" id="registerPassword" name="password" required class="mt-1">
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Register</button>
                </form>
            </section>

            <!-- Todos Section -->
            <section id="todosSection" class="page-section">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Your Todos</h2>

                <!-- Create Todo Form -->
                <form id="createTodoForm" class="mb-6 p-4 border border-gray-200 rounded-md bg-gray-50 space-y-3">
                    <label for="newTodoContent" class="block text-sm font-medium text-gray-700">New Todo:</label>
                    <input type="text" id="newTodoContent" name="content" placeholder="What do you need to do?" required class="mt-1">
                    <button type="submit" class="btn btn-success w-full">Add Todo</button>
                </form>

                <!-- Todo List -->
                <div id="todoList" class="space-y-3">
                    <!-- Todos will be dynamically loaded here -->
                    <p class="text-gray-500 text-center" id="noTodosMessage">No todos yet. Add one above!</p>
                </div>
            </section>
        </div>
    </main>

    <footer class="bg-gray-800 text-white p-4 text-center text-sm shadow-inner">
        <div class="container mx-auto">
            &copy; 2025 My Todo App. All rights reserved.
        </div>
    </footer>

    <script type="module">
        // Import login and register functions
        import { handleLogin } from './js/login.js';
        import { handleRegister } from './js/register.js';

        // --- Configuration ---
        const USER_SERVICE_URL = 'http://localhost:5000/api/users';
        const TODO_SERVICE_URL = 'http://localhost:5001/api/todos';

        // --- DOM Elements ---
        const navLoginBtn = document.getElementById('navLogin');
        const navRegisterBtn = document.getElementById('navRegister');
        const navTodosBtn = document.getElementById('navTodos');
        const navLogoutBtn = document.getElementById('navLogout');

        const loginSection = document.getElementById('loginSection');
        const registerSection = document.getElementById('registerSection');
        const todosSection = document.getElementById('todosSection');

        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const createTodoForm = document.getElementById('createTodoForm');
        const todoList = document.getElementById('todoList');
        const noTodosMessage = document.getElementById('noTodosMessage');
        const messageBox = document.getElementById('messageBox');

        let currentToken = localStorage.getItem('jwtToken'); // Get token from local storage on load

        /**
         * Setter for currentToken. Updates the token and local storage.
         * @param {string|null} newToken - The new JWT token or null to clear.
         */
        function setToken(newToken) {
            currentToken = newToken;
            if (newToken) {
                localStorage.setItem('jwtToken', newToken);
            } else {
                localStorage.removeItem('jwtToken');
            }
        }

        // --- Utility Functions ---

        /**
         * Displays a message in the message box.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', or 'info'.
         */
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = `message-box message-${type}`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000); // Hide after 5 seconds
        }

        /**
         * Switches the active section/page.
         * @param {HTMLElement} sectionToShow - The section to make visible.
         */
        function showSection(sectionToShow) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.style.display = 'none';
            });
            sectionToShow.style.display = 'block';
        }

        /**
         * Updates navigation buttons based on authentication status.
         */
        function updateNav() {
            if (currentToken) {
                navLoginBtn.style.display = 'none';
                navRegisterBtn.style.display = 'none';
                navTodosBtn.style.display = 'inline-block';
                navLogoutBtn.style.display = 'inline-block';
                showSection(todosSection); // Automatically show todos if logged in
                fetchTodos(); // Fetch todos on login/page load if authenticated
            } else {
                navLoginBtn.style.display = 'inline-block';
                navRegisterBtn.style.display = 'inline-block';
                navTodosBtn.style.display = 'none';
                navLogoutBtn.style.display = 'none';
                showSection(loginSection); // Default to login if not authenticated
            }
        }

        /**
         * Handles user logout.
         */
        function handleLogout() {
            setToken(null); // Clear the token
            showMessage('Logged out successfully!', 'info');
            updateNav();
        }

        /**
         * Fetches and displays todos for the authenticated user.
         */
        async function fetchTodos() {
            if (!currentToken) {
                showMessage('Please log in to view todos.', 'info');
                return;
            }

            try {
                const response = await fetch(TODO_SERVICE_URL, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    renderTodos(data.todos);
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.message || 'Failed to fetch todos', 'error');
                    if (response.status === 401) { // Token expired or invalid
                        handleLogout();
                    }
                }
            } catch (error) {
                console.error('Fetch todos error:', error);
                showMessage('Network error fetching todos', 'error');
            }
        }

        /**
         * Renders the list of todos in the UI.
         * @param {Array} todos - An array of todo objects.
         */
        function renderTodos(todos) {
            todoList.innerHTML = ''; // Clear existing todos
            if (todos.length === 0) {
                noTodosMessage.style.display = 'block';
                return;
            }
            noTodosMessage.style.display = 'none';

            todos.forEach(todo => {
                const todoItem = document.createElement('div');
                todoItem.className = `flex items-center justify-between p-3 bg-white rounded-md shadow-sm border ${todo.completed ? 'border-green-300' : 'border-gray-200'}`;
                todoItem.innerHTML = `
                    <span class="flex-grow text-lg ${todo.completed ? 'line-through text-gray-500' : 'text-gray-800'}">${todo.content}</span>
                    <div class="flex space-x-2 ml-4">
                        <button data-uuid="${todo.uuid}" data-completed="${todo.completed}" class="btn ${todo.completed ? 'btn-secondary' : 'btn-success'} btn-toggle-complete text-sm">
                            ${todo.completed ? 'Undo' : 'Complete'}
                        </button>
                        <button data-uuid="${todo.uuid}" class="btn btn-danger btn-delete text-sm">Delete</button>
                    </div>
                `;
                todoList.appendChild(todoItem);
            });

            // Add event listeners for new buttons
            document.querySelectorAll('.btn-toggle-complete').forEach(button => {
                button.addEventListener('click', handleToggleComplete);
            });
            document.querySelectorAll('.btn-delete').forEach(button => {
                button.addEventListener('click', handleDeleteTodo);
            });
        }

        /**
         * Handles creating a new todo.
         */
        async function handleCreateTodo(event) {
            event.preventDefault();
            const content = createTodoForm.elements.content.value;

            try {
                const response = await fetch(TODO_SERVICE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ content })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(data.message, 'success');
                    createTodoForm.reset();
                    fetchTodos(); // Refresh the list
                } else {
                    showMessage(data.message || 'Failed to create todo', 'error');
                    if (response.status === 401) {
                        handleLogout();
                    }
                }
            } catch (error) {
                console.error('Create todo error:', error);
                showMessage('Network error creating todo', 'error');
            }
        }

        /**
         * Handles toggling the completion status of a todo.
         */
        async function handleToggleComplete(event) {
            const uuid = event.target.dataset.uuid;
            const currentCompleted = event.target.dataset.completed === 'true';
            const newCompleted = !currentCompleted;

            try {
                const response = await fetch(`${TODO_SERVICE_URL}/${uuid}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ completed: newCompleted })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(data.message, 'success');
                    fetchTodos(); // Refresh the list
                } else {
                    showMessage(data.message || 'Failed to update todo status', 'error');
                    if (response.status === 401) {
                        handleLogout();
                    }
                }
            } catch (error) {
                console.error('Toggle complete error:', error);
                showMessage('Network error updating todo status', 'error');
            }
        }

        /**
         * Handles deleting a todo.
         */
        async function handleDeleteTodo(event) {
            const uuid = event.target.dataset.uuid;

            // Simple confirmation dialog
            if (!confirm('Are you sure you want to delete this todo?')) {
                return;
            }

            try {
                const response = await fetch(`${TODO_SERVICE_URL}/${uuid}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                if (response.status === 204) { // 204 No Content for successful deletion
                    showMessage('Todo deleted successfully! 🗑️', 'success');
                    fetchTodos(); // Refresh the list
                } else {
                    const data = await response.json(); // Attempt to parse error message
                    showMessage(data.message || 'Failed to delete todo', 'error');
                    if (response.status === 401) {
                        handleLogout();
                    }
                }
            } catch (error) {
                console.error('Delete todo error:', error);
                showMessage('Network error deleting todo', 'error');
            }
        }

        // --- Event Listeners ---
        navLoginBtn.addEventListener('click', () => showSection(loginSection));
        navRegisterBtn.addEventListener('click', () => showSection(registerSection));
        navTodosBtn.addEventListener('click', () => {
            showSection(todosSection);
            fetchTodos(); // Ensure todos are fetched when navigating to the section
        });
        navLogoutBtn.addEventListener('click', handleLogout);

        // Pass necessary dependencies to the imported functions
        loginForm.addEventListener('submit', (event) => handleLogin(event, loginForm, showMessage, updateNav, USER_SERVICE_URL, setToken));
        registerForm.addEventListener('submit', (event) => handleRegister(event, registerForm, showMessage, updateNav, USER_SERVICE_URL, setToken));

        createTodoForm.addEventListener('submit', handleCreateTodo);

        // --- Initial Load ---
        updateNav(); // Set initial view based on token presence
    </script>
</body>
</html>
